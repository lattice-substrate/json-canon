run:
  timeout: 5m
  tests: true
  modules-download-mode: readonly

linters:
  enable:
    # Baseline (existing set)
    - errcheck
    - gofmt
    - goimports
    - govet
    - ineffassign
    - staticcheck
    - unused
    - misspell
    - revive
    - gosimple
    - typecheck
    - unparam
    - unconvert
    - goconst
    - gocyclo
    - bodyclose
    - gosec

    # NIL SAFETY & ROBUSTNESS
    - nilnil # No (nil, nil) returns
    - nilerr # Find nil error misuse

    # ERROR HANDLING (critical for fail-closed)
    - errorlint # Proper error wrapping/comparison
    - wrapcheck # Wrap external errors
    - errname # Sentinel error naming

    # CONTEXT HANDLING
    - contextcheck # Proper context usage
    - noctx # HTTP without context

    # CODE QUALITY
    - dupl # Duplicate code detection
    - funlen # Function length limits
    - maintidx # Maintainability index
    - nestif # Deep nesting detection
    - cyclop # Better cyclomatic complexity

    # SECURITY HARDENING
    - forbidigo # Ban specific functions (time.Now!)
    - musttag # Enforce struct tags

    # PERFORMANCE
    - prealloc # Slice preallocation
    - nolintlint # Lint nolint directives
    - wastedassign # Wasted assignments

    # TEST QUALITY
    - testpackage # Separate test packages
    - tparallel # Proper t.Parallel usage
    - thelper # Test helper detection
    - testifylint # Testify best practices

    # IMPORT HYGIENE (enforce black-box!)
    - depguard # Allowlist imports
    - gomodguard # Block unwanted deps
    - importas # Consistent import aliases

    # DOCUMENTATION
    - godot # Comment punctuation
    - godox # Fail on TODO/FIXME

linters-settings:
  errcheck:
    check-type-assertions: true
    check-blank: true
    exclude-functions:
      # Only if truly safe - generally avoid exclusions

  errorlint:
    errorf: true
    asserts: true
    comparison: true

  wrapcheck:
    ignoreSigs:
      - .Errorf(
      - errors.New(
      - errors.Unwrap(
      - errors.Join(
    ignorePackageGlobs:
      - github.com/lattice-substrate/* # Internal packages

  gocyclo:
    min-complexity: 10 # Stricter than 15

  cyclop:
    max-complexity: 10
    skip-tests: false

  funlen:
    lines: 80
    statements: 50

  nestif:
    min-complexity: 4

  govet:
    enable:
      - shadow
      - nilness
      - unusedwrite
    disable:
      - fieldalignment # Can be noisy

  misspell:
    locale: US
    mode: restricted

  revive:
    confidence: 0.8
    rules:
      - name: exported
        severity: error # Not warning
      - name: error-return
      - name: error-strings
      - name: error-naming
      - name: indent-error-flow
      - name: blank-imports
      - name: var-naming
      - name: package-comments
      - name: unexported-return
      - name: time-naming
      - name: context-as-argument
      - name: context-keys-type

  gosec:
    severity: medium
    confidence: medium
    excludes:
      - G104 # Covered by errcheck
      - G304 # File paths can be from user input in CLI

  goconst:
    min-len: 3
    min-occurrences: 3

  depguard:
    rules:
      main:
        deny:
          - pkg: io/ioutil
            desc: "Deprecated, use io or os instead"
          - pkg: github.com/pkg/errors
            desc: "Use standard library errors instead"
          # Add governed repo imports here to enforce black-box
          - pkg: github.com/lattice-substrate/lattice-core/go/**
            desc: "Black-box violation - use CLI exec instead"
          - pkg: github.com/lattice-substrate/lattice-capture/go/**
            desc: "Black-box violation - use CLI exec instead"

  forbidigo:
    forbid:
      - p: ^time\.Now$
        msg: "Use injected timestamp for determinism (CLAUDE.md ยง9)"
      - p: ^rand\..*$
        msg: "Use seeded random for determinism (CLAUDE.md ยง9)"
        pkg: ^math/rand$
      - p: ^os\.Getenv$
        msg: "Ambient environment - document in CLI_ABI.md if needed (CLAUDE.md ยง9)"
      - p: ^filepath\.Walk$
        msg: "Non-deterministic traversal - use sorted alternatives (CLAUDE.md ยง9)"
    analyze-types: true

  godox:
    keywords:
      - TODO
      - FIXME
      - HACK
      - BUG

  testpackage:
    skip-regexp: (export|internal)_test\.go

  musttag:
    functions:
      - name: encoding/json.Marshal
        tag: json
        arg-pos: 0
      - name: encoding/json.Unmarshal
        tag: json
        arg-pos: 1

issues:
  exclude-use-default: false
  max-issues-per-linter: 0
  max-same-issues: 0
  uniq-by-line: true

  exclude-rules:
    # Test files can be more lenient
    - path: _test\.go
      linters:
        - gocyclo
        - cyclop
        - funlen
        - maintidx
        - gosec
        - dupl

    # Integration test helpers
    - path: integration.*_test\.go
      linters:
        - testpackage

    # Generated code
    - path: \.pb\.go$
      linters:
        - all

    # False positives on error wrapping in some cases
    - text: "returned from external package is unwrapped"
      linters:
        - wrapcheck
      path: _test\.go

output:
  formats:
    - format: colored-line-number
  print-issued-lines: true
  print-linter-name: true
  sort-results: true