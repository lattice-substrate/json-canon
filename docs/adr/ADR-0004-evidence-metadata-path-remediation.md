# ADR-0004: Evidence Metadata Path Remediation

- ADR ID: ADR-0004
- Date: 2026-02-27
- Status: Accepted
- Deciders: Maintainers
- Related Requirements: OFFLINE-EVIDENCE-001, OFFLINE-RELEASE-001

## Context

Two issues were discovered in the v0.2.0 release evidence committed to the
public repository:

1. **Local path exposure.** The offline replay harness wrote absolute filesystem
   paths (`/home/<user>/json-canon/...`) into all metadata artifacts (RUN_INDEX,
   checksums, audit summaries, cross-arch reports). Root cause: `filepath.Abs()`
   converted `--output-dir` to absolute, and all downstream write functions
   emitted these paths verbatim into artifacts.

2. **Evidence not independently generated.** The v0.2.0, v0.2.0-rc.4, and
   v0.2.0-rc.3 evidence JSON files shared an identical nanosecond timestamp.
   Evidence was generated once for rc.3, then hand-edited (commit/tag/binary-hash
   fields only) for rc.4 and v0.2.0. The metadata files still referenced
   v0.2.0-rc.3 paths.

The core evidence JSON (`offline-evidence.json`) was clean: no paths, correct
behavioral digests. The GitHub release artifacts (binary, tar.gz, SHA256SUMS,
SLSA attestation) were correct. Only the supplementary audit metadata was
affected.

## Decision

1. Fix the offline replay harness to write repo-relative paths in all evidence
   metadata artifacts by auto-detecting the repository root via
   `git rev-parse --show-toplevel` and converting absolute paths to relative
   before writing.

2. Remove the incorrect v0.2.0-rc.3, v0.2.0-rc.4, and v0.2.0 evidence from
   version control. Replace v0.2.0 evidence directory with a `SUPERSEDED.md`
   notice.

3. Add regression tests that assert no absolute paths appear in written
   artifacts (checksums, RUN_INDEX, audit summaries, cross-arch reports).

4. Release v0.2.1 as a patch with freshly generated evidence.

## Rationale

- Absolute paths expose operator filesystem structure in public artifacts,
  which is an unnecessary information disclosure.
- Hand-edited evidence violates the offline cold-replay trust model, which
  requires each evidence bundle to be independently generated by the harness.
- A patch release (v0.2.1) is correct because the stable CLI ABI surface
  (`abi_manifest.json`) is unchanged; `jcs-offline-replay` is internal release
  tooling, not part of the versioned ABI.
- Auto-detecting the repo root via `git rev-parse --show-toplevel` follows the
  existing pattern used by `resolveOfflineSourceIdentity()` for commit/tag
  resolution.

## Consequences

- All future evidence metadata uses repo-relative paths.
- Regression tests prevent recurrence of absolute path leakage.
- v0.2.0 evidence is removed from version control with a supersession notice.
- Operators reviewing historical evidence should refer to v0.2.1 for the
  corrected artifacts.

## Alternatives Considered

1. **Leave with annotation.** Rejected: undermines the trust model that
   evidence is independently generated.

2. **Add `--repo-root` flag as primary mechanism.** Rejected: auto-detection
   is more reliable for the common case. A flag could be added later for
   environments without git.

3. **Strip paths entirely from metadata.** Rejected: relative paths are useful
   for auditability and artifact tracing.
